# Win11 图片幻灯片播放器（EXE）设计方案

## 1. 目标
面向 Win11 的轻量图片幻灯片软件，满足：
- 自适应窗口/屏幕比例显示图片（保持原图比例，不拉伸变形）
- 鼠标滚轮切换上一张/下一张
- `Ctrl + 滚轮` 做图片缩放（查看细节）
- 预加载图片，减少切换时黑屏
- 幻灯片间隔可自定义，精度优于 0.05 秒（建议内部步长 10ms）
- 当前文件夹播放完后自动顺序播放下一个文件夹，尽量降低等待时间

## 2. 技术选型（推荐）
- **语言/框架**：C# + .NET 8 + WPF
- **原因**：
  - Win11 原生体验好，打包 EXE 容易
  - 图片渲染、输入事件、硬件加速支持完善
  - 定时器、异步任务和并发控制成熟

## 3. 功能设计

### 3.1 图片显示与自适应比例
- 渲染控件：`Image` + `Stretch=Uniform`
- 行为：
  - 窗口大小改变时自动重新布局
  - 保持图片宽高比，空白区域黑色或自定义背景

### 3.2 滚轮交互
- 普通滚轮（不按 Ctrl）：
  - 上滚：上一张
  - 下滚：下一张
- `Ctrl + 滚轮`：
  - 放大/缩小当前图片
  - 缩放中心跟随鼠标位置（增强观感）
  - 设置缩放上下限，例如 `0.1x ~ 8.0x`

### 3.3 预加载与缓存
采用“双层缓存 + 后台解码”策略：
- 当前显示：`Current`
- 邻近预加载：`Prev/Next`（至少 ±3 张）
- 下一个文件夹预热：当前文件夹接近末尾时，提前扫描并解码下个文件夹首批图片

实现要点：
1. 图片先在后台线程解码到 `BitmapImage`（`CacheOption=OnLoad`）
2. 解码完成后 `Freeze()`，避免 UI 线程跨线程访问问题
3. 使用 `MemoryCache + LRU`，限制最大内存占用（如 512MB，可配置）
4. 切图优先命中缓存，未命中时先显示低分辨率缩略图或上一帧，避免黑屏

### 3.4 幻灯片定时播放（高精度）
- UI 层用 `DispatcherTimer` 做状态驱动
- 实际时间基准使用 `Stopwatch` 计算误差并补偿
- 间隔设置：
  - UI 允许输入 `0.05s` 粒度
  - 内部调度粒度建议 10ms
  - 每次触发根据真实 elapsed 判断是否切图，降低系统调度抖动影响

### 3.5 文件夹顺序播放
- 支持选择“根目录”后递归/非递归策略（可配置）
- 文件夹顺序：默认按名称自然排序（A-Z / 1-9）
- 当前文件夹结束后无缝切换到下一个文件夹
- 当切到下一文件夹前，预加载线程已准备其前 N 张图片，减少等待

## 4. 核心模块划分

1. `ImageIndexService`
   - 扫描目录、构建播放队列
   - 输出结构：`Folder -> List<ImagePath>`

2. `PreloadService`
   - 后台任务队列（优先级：当前邻近 > 下一文件夹首屏）
   - 控制并发（如 2~4 个解码线程）

3. `ImageCacheService`
   - 内存缓存（LRU）
   - 提供 `GetOrLoadAsync(path)`

4. `PlaybackController`
   - 播放状态机（播放/暂停/手动切换）
   - 定时推进索引、文件夹切换

5. `ZoomPanController`
   - 处理 `Ctrl+滚轮` 缩放与拖拽平移

## 5. 关键数据结构（示例）

```csharp
public record SlideItem(string FolderPath, string FilePath, int FolderIndex, int FileIndex);

public class PlaybackState
{
    public int FolderCursor { get; set; }
    public int ImageCursor { get; set; }
    public bool IsPlaying { get; set; }
    public TimeSpan Interval { get; set; } = TimeSpan.FromMilliseconds(500);
}
```

## 6. 关键流程（切图）
1. 计算目标索引（上一张/下一张）
2. 先查缓存：命中则立即显示
3. 未命中：
   - 先显示过渡帧（避免黑屏）
   - 异步加载目标图并替换
4. 触发预加载：目标图附近 + 下一文件夹首批

## 7. 性能与稳定性建议
- 仅保留必要尺寸：超大图可按显示分辨率解码（显存/内存更友好）
- SSD 下可提高预加载并发，HDD 下减少随机读
- 大目录（>1万图）分批索引，避免启动卡顿
- 异常容错：坏图自动跳过并记录日志

## 8. UI 建议
- 主窗口：全屏/窗口模式切换
- 底部状态栏：
  - 当前文件夹、当前序号/总数
  - 播放间隔（可输入，步长 0.05s）
  - 缓存命中率、预加载状态（可选）
- 快捷键：
  - `Space` 播放/暂停
  - `←/→` 上一张/下一张
  - `Ctrl + 0` 重置缩放

## 9. 打包发布为 EXE
- `dotnet publish -c Release -r win-x64 --self-contained true /p:PublishSingleFile=true`
- 生成单文件 EXE，便于分发

## 10. 可选增强
- 跨文件夹过渡动画（淡入）
- 双屏播放
- 随机播放/循环播放模式
- GPU 加速缩放采样（提升大图流畅度）

---

如果你需要，我可以继续给出：
1) 可直接创建项目的 WPF 代码骨架；
2) 滚轮与 Ctrl+滚轮的完整事件代码；
3) 预加载队列 + LRU 缓存的可运行实现。
